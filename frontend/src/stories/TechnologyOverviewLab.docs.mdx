import React from "react";
import { Meta } from "@storybook/addon-docs/blocks";
import LastUpdated from "./components/LastUpdated";

export const parameters = { layout: "fullscreen" };

# Technology Overview Lab

A comprehensive, example-driven lab to explore Harvest.aiâ€™s frontend technology stack, how it maps to user stories, and how streaming and S2S patterns fit together.

---

## Project

- Project: Harvest.ai (Frontend)
- Repo/Path: `Harvest.ai/frontend`
- Overview: Next.js App Router UI for AI-powered content transformation with mock-first development, Storybook docs, and BYOK provider demos.

---

## Stack (by category)

- Frontend
  - Next.js 15, React 19, TypeScript 5
  - Tailwind CSS 3, PostCSS, Autoprefixer
  - Radix UI (Select, Switch, Slider, Label), Icons: Lucide, Heroicons
  - Framer Motion (animations)
  - React Markdown + remark-gfm (docs rendering)
  - Swagger UI React (API docs embedding)
- Backend (App Routes)
  - Next.js API Routes (Node runtime)
  - AI SDKs: OpenAI, Anthropic, Google Generative AI
  - Supabase JS (SSR helpers)
  - jose/jsonwebtoken/bcryptjs (auth/crypto utils)
- Testing/QA
  - Jest 29 + RTL, Playwright 1.55 (+ @axe-core/playwright), MSW 2 (+ addon in SB)
- Security
  - HSTS, CSP (connect-src to OpenAI/Anthropic), Referrer-Policy, Permissions-Policy, COOP/COEP (next.config.mjs)
- Docs & DX
  - Storybook 9 (Next+Vite), MDX docs, Swagger UI React

---

## Examples (by tech)

### Next.js (App Router)
- Used for: UI pages and serverless API routes (JSON + SSE), security headers.
- Where: `src/app/**/*`, `next.config.mjs`
- Example: Animated heading in Demo page

```tsx
// src/app/demo/page.tsx (extract)
<motion.h1
  className="text-4xl font-bold text-gray-900 dark:text-white mb-4"
  initial={{ opacity: 0, y: 20 }}
  animate={{ opacity: 1, y: 0 }}
>
  ðŸš€ Harvest.ai Content Transformer
</motion.h1>
```

### Tailwind CSS
- Used for: styling, dark mode, motion-friendly utilities.
- Where: `tailwind.config.js`
- Example: safelist + theme extension

```js
// tailwind.config.js (extract)
module.exports = {
  darkMode: ["class"],
  content: ["./src/**/*.{js,jsx,ts,tsx}", "./public/index.html"],
  safelist: ["bg-blue-500/10", "bg-purple-500/10", "bg-green-500/10", "bg-orange-500/10"],
  theme: { extend: { borderRadius: { lg: "var(--radius)" } } },
  plugins: [require("tailwindcss-animate")],
};
```

### Radix UI (Select, Switch, Slider, Label)
- Used for: accessible, composable UI primitives.
- Where: `src/components/ui/*`, used by content generator.
- Example: Select + Slider + Switch in one panel

```tsx
// src/components/content/ContentGenerator.tsx (extract)
<Label htmlFor="format">Format</Label>
<Select value={format} onValueChange={setFormat}>
  <SelectTrigger id="format"><SelectValue /></SelectTrigger>
  <SelectContent>
    {formats.map((f) => (
      <SelectItem key={f.value} value={f.value}>{f.label}</SelectItem>
    ))}
  </SelectContent>
</Select>

<Label htmlFor="length">Max Length: {length[0]} words</Label>
<Slider id="length" value={length} onValueChange={setLength} max={1000} min={100} step={100} />

<Switch id="keywords" checked={includeKeywords} onCheckedChange={setIncludeKeywords} />
```

### Framer Motion
- Used for: progressive reveals, dropdowns, floating UI.
- Where: `src/app/demo/page.tsx`, `src/components/layout/Navigation.tsx`
- Example: dropdown animation in nav

```tsx
// src/components/layout/Navigation.tsx (extract)
{isProductDropdownOpen && (
  <motion.div
    initial={{ opacity: 0, y: -10 }}
    animate={{ opacity: 1, y: 0 }}
    exit={{ opacity: 0, y: -10 }}
    className="absolute top-full left-0 mt-2 w-80 bg-white rounded-xl shadow-xl"
  >
    {/* ...items */}
  </motion.div>
)}
```

### React Markdown + remark-gfm
- Used for: rendering repo docs in-app.
- Where: `src/app/doc/page.tsx`
- Example: MD rendering with custom heading anchors

```tsx
// src/app/doc/page.tsx (extract)
<ReactMarkdown remarkPlugins={[remarkGfm]} components={{
  h1: ({ children }) => <Heading level={1}>{children}</Heading>,
  h2: ({ children }) => <Heading level={2}>{children}</Heading>,
}}>
  {content}
</ReactMarkdown>
```

### Swagger UI React
- Used for: embedding API docs UI.
- Where: `src/components/SwaggerUIPage.tsx`
- Example: mount on `/api/openapi.json`

```tsx
// src/components/SwaggerUIPage.tsx (extract)
<SwaggerUI url="/api/openapi.json" docExpansion="list" tryItOutEnabled />
```

### Supabase (SSR + browser)
- Used for: session/DB access; cache/usage logging in AI service.
- Where: `src/lib/supabase/*`, `src/lib/ai/service.ts`
- Example: server-side client using Next cookies

```ts
// src/lib/supabase/server.ts (extract)
export async function createClient() {
  const cookieStore = await cookies();
  return createServerClient<Database>(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
    { cookies: { get: (n) => cookieStore.get(n)?.value, set: (n,v,o) => { try { cookieStore.set({ name:n, value:v, ...o }); } catch {} }, remove: (n,o) => { try { cookieStore.set({ name:n, value:"", ...o }); } catch {} } } },
  );
}
```

### AI SDKs (OpenAI, Anthropic, Google Generative AI)
- Used for: content generation with fallback; embeddings.
- Where: `src/lib/ai/service.ts`
- Example: OpenAI generation

```ts
// src/lib/ai/service.ts (extract)
const completion = await this.openai.chat.completions.create({
  model,
  messages: [
    { role: "system", content: this.getSystemPrompt(options) },
    { role: "user", content: prompt },
  ],
  temperature: options.temperature || 0.7,
  max_tokens: options.maxTokens || 2000,
});
const content = completion.choices[0].message.content || "";
```

### MSW 2 (mock-first)
- Used for: dev/E2E/Storybook API mocking.
- Where: `src/mocks/*`, `.storybook/preview.ts`
- Example: `/api/generate` handler with triggers and network controls

```ts
// src/mocks/handlers/generation.ts (extract)
http.post("/api/generate", async ({ request }) => {
  const injected = await maybeInjectNetworkControls(request as unknown as Request);
  if (injected) return injected;
  await delay(faker.number.int({ min: 300, max: 1200 }));
  // ...return structured mock result
});
```

### Jest + Testing Library
- Used for: component/route unit tests.
- Where: `src/**/__tests__`, `jest.config.js`
- Example: Footer content assertions

```tsx
// src/components/__tests__/Footer.test.tsx (extract)
render(<Footer darkMode={false} />);
expect(screen.getByText("Harvest.ai")).toBeInTheDocument();
expect(screen.getByText(/AI-powered content transformation platform/)).toBeInTheDocument();
```

### Playwright + @axe-core/playwright
- Used for: E2E + accessibility checks.
- Where: `tests/e2e/*.spec.ts`, `playwright.config.ts`
- Example: Axe scan on home

```ts
// tests/e2e/a11y.spec.ts (extract)
await page.goto("/");
const results = await new AxeBuilder({ page }).analyze();
const severe = results.violations.filter((v) => ["critical"].includes(v.impact || ""));
expect(severe).toEqual([]);
```

### Security headers (HSTS, CSP, COOP/COEP)
- Used for: secure defaults & cross-origin isolation.
- Where: `next.config.mjs`
- Example: CSP connect-src whitelisting providers

```js
// next.config.mjs (extract)
headers: [
  { key: "Strict-Transport-Security", value: "max-age=31536000; includeSubDomains; preload" },
  { key: "Content-Security-Policy", value: "default-src 'self'; script-src 'self'; style-src 'self' 'unsafe-inline'; connect-src 'self' https://api.openai.com https://api.anthropic.com; frame-ancestors 'none'; base-uri 'none'" },
]
```

---

## User stories â†’ technology mapping

1) As a user, I can transform input content into a professional format
- UI: `src/components/content/ContentGenerator.tsx` (Radix Select/Slider/Switch)
- API: `src/app/api/generate/route.ts` (JSON + SSE modes)
- Mocks: `src/mocks/handlers/generation.ts` (TRIGGER_* cases)
- Tests: `tests/e2e/content-generation.spec.ts`, `tests/e2e/demo.spec.ts`
- Docs: `docs/architecture/GENERATION_FLOW.md`

2) As a user, I can browse project documentation inside the app
- UI: `src/app/doc/page.tsx` (React Markdown + remark-gfm)
- Sources: `/docs/**/*`
- Tests: `tests/e2e/docs-api.spec.ts`

3) As a user, I can try BYOK (Bring Your Own Key) flows
- Hook: `src/hooks/useAIChat.ts` (streaming support)
- API: `src/app/api/ai/chat/route.ts` (provider-specific shapes)
- UI: `src/app/demo/byok/page.tsx`
- Docs: `docs/api/BYOK_API.md`

4) As a user, I see streaming progress during generation
- UI: `src/app/demo/page.tsx` (progress + stream text)
- SSE Helpers: `src/app/playground/sse/page.tsx`, `src/lib/client/sseParser.ts`, `src/lib/client/useSSEStream.ts`
- Tests: `tests/e2e/generate-stream.spec.ts`, `tests/e2e/threads-stream.spec.ts`

5) As a developer, I can run the app entirely with mocks (mock-first)
- Worker: `src/mocks/browser.ts` (public worker), `src/mocks/server.ts` (node)
- Handlers: `src/mocks/handlers/*.ts`
- Storybook: `.storybook/preview.ts` wires handlers via msw addon
- Commands: `npm run dev:mock`, `npm run test:e2e`

---

## Streaming & S2S (server-to-server) overview

Although this is the frontend, the repo includes comprehensive S2S learning materials and Storybook labs that show how S2S and streaming fit together.

- Live SSE client (in-app): `src/app/playground/sse/page.tsx` â€” minimal streaming client

```tsx
// src/app/playground/sse/page.tsx (extract)
const res = await fetch(url, { ...init, signal: ctrl.signal });
if (!res.ok || !res.body) throw new Error(`HTTP ${res.status}`);
const reader = res.body.getReader();
const decoder = new TextDecoder();
let buffer = "";
while (true) {
  const { value, done } = await reader.read();
  if (done) break;
  buffer += decoder.decode(value, { stream: true });
  // parse event-chunks ...
}
```

- Storybook S2S Labs (recipes and journeys):
  - `src/stories/S2SStreaming.docs.mdx`
  - `src/stories/S2SRecipes.docs.mdx`
  - `src/stories/S2SReference.docs.mdx`
  - Extended journeys: `src/stories/Lab/S2S-Journeys-Extended.docs.mdx`

- E2E S2S tests (frontend expectations):
  - `tests/e2e/s2s-api.spec.ts`

- Architecture & Ops (for end-to-end context):
  - `docs/runbooks/OPERATIONS_BOOK.md` (transport fallback)
  - `docs/architecture/MOCK_FIRST_BACKEND.md`
  - `docs/S2S_STORIES.md`

---

## Hands-on lab tasks

1) Try generation with different triggers (in Storybook API Playground or app demo)
- Use inputs like `TRIGGER_RATE_LIMIT` and `TRIGGER_ERROR` to exercise error paths.

2) Visualize docs inside the app
- Open `/doc?path=docs/SYSTEM_STATUS.md` (Docs â†’ System Status pages exist in Storybook too).

3) Explore streaming
- Run `npm run dev:e2e` and visit `/playground/sse`; compare with S2S Storybook labs.

4) Add a simple chart (planned)
- Use Recharts to show tokens/cost â€” see suggested example in Tech Stack page.

---

## Docs Status

export function DocsStatus() {
  const [data, setData] = React.useState<any>(null)
  const [src, setSrc] = React.useState('')
  const [err, setErr] = React.useState('')
  React.useEffect(() => {
    let alive = true
    async function load() {
      const tryUrls = ['/devmentor/docs/manifest.json', '/docs/manifest.json']
      for (const u of tryUrls) {
        try {
          const r = await fetch(u)
          if (r.ok) {
            const j = await r.json()
            if (!alive) return
            setData(j); setSrc(u); return
          }
        } catch {}
      }
      setErr('Could not load docs manifest')
    }
    load()
    return () => { alive = false }
  }, [])

  function fmt(d?: string) {
    try { return d ? new Date(d).toLocaleString() : '' } catch { return '' }
  }

  if (err) return <div style={{ fontFamily: 'monospace', color: 'crimson' }}>DocsStatus error: {err}</div>
  if (!data) return <div style={{ fontFamily: 'monospace' }}>Loading docs statusâ€¦</div>

  const entries = Array.isArray(data?.tree) ? data.tree : []
  const find = (name: string) => entries.find((e: any) => e?.name === name || e?.path?.endsWith('/'+name))
  const devlog = entries.find((e: any) => e?.path?.endsWith('/docs/status/DEVLOG.md') || e?.name === 'DEVLOG.md')
  const sys = find('SYSTEM_STATUS.md')
  const epics = entries.find((e: any) => e?.path?.endsWith('/docs/roadmap/EPICS.md') || e?.name === 'EPICS.md')

  return (
    <div style={{ border:'1px solid #eee', borderRadius: 8, padding: 12, background: '#fff' }}>
      <div style={{ fontSize: 12, color: '#666', marginBottom: 6 }}>Manifest: {src}</div>
      <div style={{ display:'grid', gridTemplateColumns:'1fr 1fr 1fr', gap: 8 }}>
        <div>
          <div style={{ fontWeight:600 }}>DEVLOG.md</div>
          <div style={{ fontSize:12, color:'#555' }}>mtime: {fmt(devlog?.mtimeIso || devlog?.mtime || devlog?.modifiedAt)} </div>
        </div>
        <div>
          <div style={{ fontWeight:600 }}>SYSTEM_STATUS.md</div>
          <div style={{ fontSize:12, color:'#555' }}>mtime: {fmt(sys?.mtimeIso || sys?.mtime || sys?.modifiedAt)} </div>
        </div>
        <div>
          <div style={{ fontWeight:600 }}>EPICS.md</div>
          <div style={{ fontSize:12, color:'#555' }}>mtime: {fmt(epics?.mtimeIso || epics?.mtime || epics?.modifiedAt)} </div>
        </div>
      </div>
    </div>
  )
}

<DocsStatus />

## Project references

- App dev: http://localhost:3000
- Storybook: http://localhost:6006
- Docs: README.md; `/docs/**/*`; Swagger UI via `src/components/SwaggerUIPage.tsx` (`/api/openapi.json`)

<Meta title="Labs/Technology Overview Lab" />

<LastUpdated file="src/stories/TechnologyOverviewLab.docs.mdx" />


import * as React from "react";
const { useState, useRef, useEffect } = React;
import { Meta, Canvas } from "@storybook/addon-docs";

# SSE Panel (Live)

<Meta title="Lab/SSE Panel (Live)" />

A small live panel to open an SSE stream from `/api/generate` and visualize events. Useful for demos and debugging the streaming pipeline.

export function SSEPanel() {
  const [input, setInput] = useState("Stream this content...");
  const [format, setFormat] = useState("blog");
  const [events, setEvents] = useState([]);
  const [busy, setBusy] = useState(false);
  const abortRef = useRef(null);

function push(ev) {
setEvents((prev) => [{ t: new Date().toLocaleTimeString(), ...ev }, ...prev].slice(0, 200));
}

async function start() {
if (busy) return;
setEvents([]);
setBusy(true);
const ctrl = new AbortController();
abortRef.current = ctrl;
try {
const res = await fetch("/api/generate", {
method: "POST",
headers: { "Content-Type": "application/json", Accept: "text/event-stream" },
body: JSON.stringify({ input, format }),
signal: ctrl.signal,
});
if (!res.body) throw new Error("No SSE body");
const reader = res.body.getReader();
const decoder = new TextDecoder();
let buffer = "";
while (true) {
const { done, value } = await reader.read();
if (done) break;
buffer += decoder.decode(value, { stream: true });
let parts = buffer.split("\n\n");
buffer = parts.pop() || "";
for (const part of parts) {
const lines = part.split("\n");
let evName = "message";
let dataLines = [];
for (const ln of lines) {
if (ln.startsWith("event:")) evName = ln.slice(6).trim();
if (ln.startsWith("data:")) dataLines.push(ln.slice(5).trim());
}
const raw = dataLines.join("\n");
let parsed = raw;
try { parsed = JSON.parse(raw); } catch {}
push({ event: evName, data: parsed });
}
}
push({ event: "done", data: { ok: true } });
} catch (e) {
push({ event: "error", data: String(e && e.message ? e.message : e) });
} finally {
setBusy(false);
}
}

function stop() {
abortRef.current?.abort();
setBusy(false);
}

return (

<div style={{ display: "grid", gap: 12, maxWidth: 900 }}>
<div style={{ display: "grid", gridTemplateColumns: "1fr 220px", gap: 12 }}>
<label>
<div style={{ fontSize: 12 }}>Input</div>
<textarea style={{ width: "100%", height: 120 }} value={input} onChange={(e) => setInput(e.target.value)} />
</label>
<label>
<div style={{ fontSize: 12 }}>Format</div>
<select value={format} onChange={(e) => setFormat(e.target.value)}>
<option value="blog">blog</option>
<option value="summary">summary</option>
<option value="email">email</option>
<option value="presentation">presentation</option>
</select>
</label>
</div>

      <div style={{ display: "flex", gap: 8 }}>
        <button onClick={start} disabled={busy} style={{ padding: "6px 10px" }}>Start SSE</button>
        <button onClick={stop} disabled={!busy} style={{ padding: "6px 10px" }}>Stop</button>
      </div>

      <div>
        <div style={{ fontWeight: 600 }}>Events</div>
        <pre style={{ maxHeight: 280, overflow: "auto", background: "#111", color: "#0f0", padding: 12 }}>
          {events.map((e, i) => `${e.t} ${e.event}: ${typeof e.data === 'string' ? e.data : JSON.stringify(e.data)}`).join("\n")}
        </pre>
      </div>
    </div>

);
}

<Canvas>
  <SSEPanel />
</Canvas>

import { Meta } from "@storybook/addon-docs/blocks";
import InlineToc from "../components/InlineToc";
import LastUpdated from "../components/LastUpdated";

# AI Service Lab

<Meta title="Labs/AI Service Lab" />

Hands-on lab for the AIService (src/lib/ai/service.ts): fallback chain, caching, basic cost/quality scoring, and error classes. Pairs with unit tests in src/lib/ai/__tests__/service.test.ts.

<InlineToc
  items={[
    { href: "#overview", label: "Overview" },
    { href: "#fallback", label: "Fallback chain" },
    { href: "#caching", label: "Caching" },
    { href: "#errors", label: "Error classes" },
    { href: "#quality", label: "Quality score" },
    { href: "#embeddings", label: "Embeddings" },
    { href: "#tests", label: "Unit tests (TDD)" },
  ]}
/>

## Overview {#overview}

- Primary method: generateContent(input, options, userId?) → GenerationResult
- Providers: OpenAI, Anthropic, Gemini
- Storage: optional Supabase rows (content_generations, cache, usage_logs) when userId provided and env configured

## Fallback chain {#fallback}

The service tries the requested provider first, then falls back to others based on availability or errors.

Try it:
1) Run the dev server with mocks (no real keys needed): `npm run dev:e2e`
2) Use Command Center → S2S — Streaming & Threads → Generate JSON then SSE
3) Toggle inputs to include TRIGGER_ERROR to exercise fallback

Optional (real provider):
- Set PROVIDERS_ON=1 and export specific API keys (do not commit secrets)
- The provider adapters will use SDKs when keys exist; otherwise mock/simulate

## Caching {#caching}

- Key: sha256 of first 100 chars of input + options
- Storage: `cache` table (Supabase) in real mode; in dev mocks simulate
- Bypass: send header `x-cache-bypass: 1`

Try it:
- Call /api/generate twice with same input: second call should be instant (cached)
- Add x-cache-bypass to force regeneration

## Error classes {#errors}

- 429 rate-limit → advise retry/backoff
- 401 invalid API key → prompt to update BYOK
- 402 quota exceeded → route to provider billing
- 5xx provider error → fallback or fail with aggregated message

Use TRIGGER_RATE_LIMIT and TRIGGER_ERROR in inputs to exercise paths.

## Quality score {#quality}

- Heuristics combine length appropriateness, basic format checks, and a simple complexity comparison
- Visible in JSON result as `qualityScore`

Try it:
- Compare `length: short|medium|long` and observe changes to `qualityScore`

## Embeddings {#embeddings}

- Method: generateEmbedding(text) using OpenAI embeddings when configured
- Throws when OPENAI_API_KEY is missing

Try it (optional):
- With OPENAI_API_KEY set, run unit tests for embeddings

## Unit tests (TDD) {#tests}

```bash
# Run only AI service tests
npm test -- src/lib/ai/__tests__/service.test.ts
```

- Add cases for new error categories or provider toggles as you extend the service

<LastUpdated file="src/stories/Labs/AIServiceLab.docs.mdx" />


# API Usage

This guide shows how to interact with key API endpoints locally and in CI, including how to use the MSW mock triggers for development and E2E tests.

## Quick links

- Swagger UI: /docs/api
- OpenAPI JSON: /api/openapi.json
- Docs index: /docs

## Development mode with MSW

- Start the app in mock mode:

```bash path=null start=null
npm run dev:mock
```

- This sets NEXT_PUBLIC_ENABLE_MSW=1 so the browser initializes MSW and WebSocket mocks.
- In normal development (npm run dev), MSW may be disabled depending on your setup. Use mock mode to simulate backend behavior end-to-end without a live API.

## POST /api/generate

- Typical payload

```json path=null start=null
{
  "input": "Write me a short blog post about Harvest.ai",
  "format": "blog"
}
```

- curl example

```bash path=null start=null
curl -sS -X POST \
  -H "Content-Type: application/json" \
  -d '{"input":"Write me a short blog post about Harvest.ai","format":"blog"}' \
  http://localhost:3000/api/generate
```

- Browser (JS) example

```js path=null start=null
async function callGenerate(input, format = "blog") {
  const res = await fetch("/api/generate", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ input, format }),
  });
  if (!res.ok) throw new Error(`HTTP ${res.status}`);
  return res.json();
}
```

### Mock triggers (MSW)

In mock mode, you can simulate different scenarios by sending special input values:

- TRIGGER_RATE_LIMIT → returns a 429 rate limit response
- TRIGGER_ERROR → returns an error response (e.g., 5xx)
- TRIGGER_CACHED → returns a cached/success response

Examples:

```bash path=null start=null
# Rate limit
curl -sS -X POST -H "Content-Type: application/json" \
  -d '{"input":"TRIGGER_RATE_LIMIT","format":"blog"}' \
  http://localhost:3002/api/generate

# Error
curl -sS -X POST -H "Content-Type: application/json" \
  -d '{"input":"TRIGGER_ERROR","format":"blog"}' \
  http://localhost:3002/api/generate

# Cached/Success
curl -sS -X POST -H "Content-Type: application/json" \
  -d '{"input":"TRIGGER_CACHED","format":"blog"}' \
  http://localhost:3002/api/generate
```

Playwright E2E tests use these triggers to verify error handling, caching behavior, and happy paths.

## Realtime and streaming

This app includes a realtime demo using a mock WebSocket with progressive streaming messages when running in mock mode. You can also see a realtime demonstration in Storybook (Realtime story). For production, refer to the Operations Summary for a WS→SSE/polling fallback design and hardening checklist.

## Troubleshooting

- If your requests appear to go to the mocks in development when you expect a real backend, ensure NEXT_PUBLIC_ENABLE_MSW is not set to 1.
- Swagger UI (at /docs/api) reads from /api/openapi.json. Verify that endpoint returns JSON.
- For E2E reliability, prefer mock triggers over brittle time-based assumptions.

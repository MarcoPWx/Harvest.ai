import React, { useEffect, useState } from "react";
import { Meta, Canvas, Story } from "@storybook/addon-docs/blocks";
import LastUpdated from "./components/LastUpdated";

export const parameters = {
  repoDocPath: "/docs/roadmap/EPIC_MANAGEMENT_SPEC.md",
  repoDocLabel: "Epic Management — Deep Dive",
};

# Epics Editor — Command Center

<Meta title="Command Center/Epics Editor" />

This editor lets you create and update epics using the mock-first API. If the API is unavailable, changes are kept locally for demo purposes.

export function EpicsEditor() {
  const [rows, setRows] = useState([])
  const [err, setErr] = useState('')
  const [title, set] = useState('')
  const [description, set] = useState('')
  const [status, setStatus] = useState('proposed')
  const [saving, setSaving] = useState(false)

useEffect(() => {
let alive = true
async function load() {
try {
const r = await fetch('/api/epics')
if (r.ok) {
const j = await r.json()
if (alive) setRows(Array.isArray(j) ? j : (j?.data || []))
return
}
} catch {}
// fallback sample
try {
const s = await fetch('/docs/roadmap/epics.sample.json')
if (s.ok) {
const j = await s.json()
if (alive) setRows(j?.epics || [])
return
}
} catch {}
}
load()
return () => { alive = false }
}, [])

async function createEpic() {
if (!title.trim()) return
const newEpic = { title, description, status }
setSaving(true)
try {
const r = await fetch('/api/epics', {
method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify(newEpic)
})
if (r.ok) {
const j = await r.json()
setRows(prev => [j, ...prev])
set(''); set(''); setStatus('proposed')
return
}
// fallback to local
setRows(prev => [{ id: `E-${Date.now()}`, ...newEpic }, ...prev])
} catch (e) {
setErr(e?.message || String(e))
setRows(prev => [{ id: `E-${Date.now()}`, ...newEpic }, ...prev])
} finally {
setSaving(false)
}
}

async function updateStatus(idx, next){
const item = rows[idx]
const updated = { ...item, status: next }
setRows(prev => prev.map((r,i)=> i===idx ? updated : r))
try {
if (item?.id) {
await fetch(`/api/epics/${encodeURIComponent(item.id)}`, {
method:'PUT', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify({ status: next })
})
}
} catch {}
}

const statuses = ['proposed','in-progress','done']

return (

<div style={{ maxWidth: 920 }}>
{err && <div style={{ color:'crimson', fontFamily:'monospace' }}>Error: {err}</div>}
<div style={{ border:'1px solid #eee', borderRadius:8, padding:12, marginBottom:12 }}>
<div style={{ fontWeight:600, marginBottom:6 }}>Create Epic</div>
<div style={{ display:'grid', gridTemplateColumns:'1fr', gap:8 }}>
<input placeholder="" value={title} onChange={e=>set(e.target.value)} style={{ padding:8, border:'1px solid #ddd', borderRadius:6 }} />
<textarea placeholder="" value={description} onChange={e=>set(e.target.value)} style={{ padding:8, border:'1px solid #ddd', borderRadius:6, minHeight:80 }} />
<div>
<label style={{ fontSize:12, marginRight:8 }}>Status</label>
<select value={status} onChange={e=>setStatus(e.target.value)}>
{statuses.map(s => <option key={s} value={s}>{s}</option>)}
</select>
</div>
<button onClick={createEpic} disabled={saving || !title.trim()} style={{ padding:'8px 12px' }}>{saving ? 'Saving…' : 'Create'}</button>
</div>
</div>

      <div style={{ display:'grid', gap:10 }}>
        {rows.map((e, i) => (
          <div key={e.id || i} style={{ border:'1px solid #eee', borderRadius:8, padding:12 }}>
            <div style={{ display:'flex', justifyContent:'space-between', alignItems:'center', marginBottom:6 }}>
              <div style={{ fontWeight:600 }}>{e.title || `Epic ${e.id}`}</div>
              <select value={e.status || 'proposed'} onChange={ev=>updateStatus(i, ev.target.value)}>
                {statuses.map(s => <option key={s} value={s}>{s}</option>)}
              </select>
            </div>
            {e.description && <div style={{ fontSize:14, color:'#444', marginBottom:8 }}>{e.description}</div>}
          </div>
        ))}
      </div>
    </div>

)
}

<Canvas>
  <Story name="Editor">
    <EpicsEditor />
  </Story>
</Canvas>

<LastUpdated file="src/stories/CommandCenterEpicsEditor.stories.mdx" />

import { Meta, Canvas } from "@storybook/addon-docs/blocks";
import React, { useEffect, useState } from "react";
import LastUpdated from "./components/LastUpdated";

export const parameters = { layout: "fullscreen" };

# Epics Manager (Board + Editor + Spec)

Single, canonical place to view and manage epics during demos. Reads the Spec doc, lists epics (API or sample), and provides a simple editor (mock-first). Use this page as the ONE entry point for epic management.

<Meta title="Command Center/Epics Manager" />

## Spec (source of truth)

export function EpicsSpecDoc() {
  const [html, setHtml] = useState("");
  const [err, setErr] = useState("");
  useEffect(() => {
    let alive = true;
    function esc(s) {
      return s
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#39;");
    }
    function toHtml(md) {
      const re = /```([a-zA-Z0-9_-]+)?\n([\s\S]*?)```/g;
      let last = 0,
        m,
        out = [];
      while ((m = re.exec(md)) !== null) {
        if (m.index > last) out.push({ k: "t", v: md.slice(last, m.index) });
        out.push({ k: "c", l: m[1] || "", v: m[2] || "" });
        last = re.lastIndex;
      }
      if (last < md.length) out.push({ k: "t", v: md.slice(last) });
      const chunks = out
        .map((p) =>
          p.k === "c"
            ? `<pre style="background:#0b0f19;color:#e6edf3;padding:12px;border-radius:6px;overflow:auto"><code class="language-${esc(p.l)}">${esc(p.v)}</code></pre>`
            : p.v
                .replace(/^######\s+(.*)$/gm, "<h6>$1</h6>")
                .replace(/^#####\s+(.*)$/gm, "<h5>$1</h5>")
                .replace(/^####\s+(.*)$/gm, "<h4>$1</h4>")
                .replace(/^###\s+(.*)$/gm, "<h3>$1</h3>")
                .replace(/^##\s+(.*)$/gm, "<h2>$1</h2>")
                .replace(/^#\s+(.*)$/gm, "<h1>$1</h1>")
                .replace(
                  /`([^`]+)`/g,
                  (_, c) =>
                    `<code style="background:#f6f8fa;padding:2px 4px;border-radius:4px">${esc(c)}</code>`,
                )
                .replace(
                  /\[([^\]]+)\]\((https?:[^)]+)\)/g,
                  '<a href="$2" target="_blank" rel="noreferrer">$1</a>',
                ),
        )
        .join("\n");
      setHtml(chunks);
    }
    async function load() {
      try {
        const r = await fetch("/docs/roadmap/EPICS.md");
        if (!alive) return;
        if (!r.ok) throw new Error("HTTP " + r.status);
        const t = await r.text();
        toHtml(t);
      } catch (e) {
        alive && setErr(String(e));
      }
    }
    load();
    return () => {
      alive = false;
    };
  }, []);
  if (err) return <div style={{ fontFamily: "monospace", color: "crimson" }}>Error: {err}</div>;
  if (!html) return <div style={{ fontFamily: "monospace" }}>Loading EPICS.md…</div>;
  return (
    <div
      style={{ border: "1px solid #eee", borderRadius: 6, padding: 12, background: "#fff" }}
      dangerouslySetInnerHTML={{ __html: html }}
    />
  );
}

<Canvas>
  <EpicsSpecDoc />
</Canvas>

<LastUpdated file="docs/roadmap/EPICS.md" />

## Board (list epics)

export function EpicsBoard() {
  const [rows, setRows] = useState([])
  const [err, setErr] = useState('')
  useEffect(()=>{
    let alive=true
    async function load(){
      try{ const r=await fetch('/api/epics'); if(r.ok){ const j=await r.json(); if(alive) setRows(Array.isArray(j)?j:(j?.data||[])); return }
      }catch{}
      try{ const s=await fetch('/docs/roadmap/epics.sample.json'); if(s.ok){ const j=await s.json(); if(alive) setRows(j?.epics||[]); return } }catch{}
      setErr('No epics source available')
    }
    load(); return()=>{alive=false}
  },[])
  const StatusTag=({s}:{s:string})=> (
    <span style={{display:'inline-block',padding:'2px 6px',borderRadius:6,fontSize:12,background:s==='done'?'#e6ffed':s==='in-progress'?'#fff7e6':'#e6f0ff',color:s==='done'?'#027a48':s==='in-progress'?'#b25e09':'#0747a6',border:'1px solid #eee'}}>{s}</span>
  )
  if(err) return <div style={{fontFamily:'monospace',color:'crimson'}}>Error: {err}</div>
  if(!rows.length) return <div style={{fontFamily:'monospace'}}>Loading epics…</div>
  return (
    <div style={{display:'grid',gap:10}}>
      {rows.map((e:any,i:number)=> (
        <div key={e.id||i} style={{border:'1px solid #eee',borderRadius:8,padding:12}}>
          <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:6}}>
            <div style={{fontWeight:600}}>{e.title||`Epic ${e.id}`}</div>
            {e.status && <StatusTag s={e.status} />}
          </div>
          {e.description && <div style={{fontSize:14,color:'#444',marginBottom:8}}>{e.description}</div>}
          {Array.isArray(e.links)&&e.links.length>0 && (
            <div style={{fontSize:12}}>Links: {e.links.map((l:string,idx:number)=>(<a key={idx} href={l} target="_blank" rel="noreferrer" style={{marginRight:8}}>{l}</a>))}</div>
          )}
        </div>
      ))}
    </div>
  )
}

<Canvas>
  <EpicsBoard />
</Canvas>

## Editor (mock-first)

export function EpicsEditor() {
  const [rows, setRows] = useState<any[]>([])
  const [err, setErr] = useState('')
  const [title, setTitle] = useState('')
  const [description, setDesc] = useState('')
  const [status, setStatus] = useState('proposed')
  const [saving, setSaving] = useState(false)

useEffect(()=>{
let alive=true
async function load(){
try{const r=await fetch('/api/epics'); if(r.ok){ const j=await r.json(); if(alive) setRows(Array.isArray(j)?j:(j?.data||[])); return }}catch{}
try{const s=await fetch('/docs/roadmap/epics.sample.json'); if(s.ok){ const j=await s.json(); if(alive) setRows(j?.epics||[]) }}catch{}
}
load(); return()=>{alive=false}
},[])

async function createEpic(){
if(!title.trim()) return
const payload={ title, description, status }
setSaving(true)
try{
const r=await fetch('/api/epics',{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) })
if(r.ok){ const j=await r.json(); setRows(prev=>[j,...prev]); setTitle(''); setDesc(''); setStatus('proposed'); return }
// fallback: prepend locally
setRows(prev=>[{ id:`E-${Date.now()}`, ...payload }, ...prev])
}catch(e:any){ setErr(e?.message||String(e)); setRows(prev=>[{ id:`E-${Date.now()}`, ...payload }, ...prev]) }
finally{ setSaving(false) }
}

async function updateStatus(idx:number, next:string){
const item=rows[idx]; const updated={...item, status: next}
setRows(prev=>prev.map((r,i)=> i===idx?updated:r))
try{ if(item?.id){ await fetch(`/api/epics/${encodeURIComponent(item.id)}`,{ method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ status: next }) }) } }catch{}
}

const statuses=['proposed','in-progress','done']

return (

<div style={{ maxWidth: 920 }}>
{err && <div style={{ color:'crimson', fontFamily:'monospace' }}>Error: {err}</div>}
<div style={{ border:'1px solid #eee', borderRadius:8, padding:12, marginBottom:12 }}>
<div style={{ fontWeight:600, marginBottom:6 }}>Create Epic</div>
<div style={{ display:'grid', gridTemplateColumns:'1fr', gap:8 }}>
<input placeholder="Title" value={title} onChange={e=>setTitle(e.target.value)} style={{ padding:8, border:'1px solid #ddd', borderRadius:6 }} />
<textarea placeholder="Description" value={description} onChange={e=>setDesc(e.target.value)} style={{ padding:8, border:'1px solid #ddd', borderRadius:6, minHeight:80 }} />
<div>
<label style={{ fontSize:12, marginRight:8 }}>Status</label>
<select value={status} onChange={e=>setStatus(e.target.value)}>
{statuses.map(s=> <option key={s} value={s}>{s}</option>)}
</select>
</div>
<button onClick={createEpic} disabled={saving || !title.trim()} style={{ padding:'8px 12px' }}>{saving? 'Saving…':'Create'}</button>
</div>
</div>

      <div style={{ display:'grid', gap:10 }}>
        {rows.map((e:any,i:number)=> (
          <div key={e.id||i} style={{ border:'1px solid #eee', borderRadius:8, padding:12 }}>
            <div style={{ display:'flex', justifyContent:'space-between', alignItems:'center', marginBottom:6 }}>
              <div style={{ fontWeight:600 }}>{e.title||`Epic ${e.id}`}</div>
              <select value={e.status||'proposed'} onChange={ev=>updateStatus(i,(ev.target as HTMLSelectElement).value)}>
                {statuses.map(s=> <option key={s} value={s}>{s}</option>)}
              </select>
            </div>
            {e.description && <div style={{ fontSize:14, color:'#444', marginBottom:8 }}>{e.description}</div>}
          </div>
        ))}
      </div>
    </div>

)
}

<Canvas>
  <EpicsEditor />
</Canvas>

<LastUpdated file="src/stories/CommandCenterEpicsManager.docs.mdx" />
